<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cubo FPS - Conexión Reforzada</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #05050a; font-family: 'Segoe UI', sans-serif; }
        #menu-inicio {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(10, 10, 25, 0.95); padding: 30px; border-radius: 20px;
            color: white; text-align: center; border: 2px solid #00ff88; z-index: 100;
        }
        .slider-container { margin: 20px 0; }
        input[type=range] { width: 100%; accent-color: #00ff88; cursor: pointer; }
        button {
            background: #00ff88; border: none; padding: 12px 40px;
            font-size: 1.1em; font-weight: bold; border-radius: 8px;
            cursor: pointer; transition: 0.3s;
        }
        button:hover { background: #00cc7a; transform: scale(1.05); }
        #ui { position: absolute; top: 20px; left: 20px; color: white; display: none; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

<div id="menu-inicio">
    <h1 style="margin:0; color: #00ff88;">CUBO ARENA</h1>
    <p id="status-text" style="color: #aaa;">Estado: Esperando...</p>
    <div class="slider-container">
        <label>Sensibilidad: <span id="sens-val">0.0020</span></label><br><br>
        <input type="range" id="sens-slider" min="0.0005" max="0.01" step="0.0005" value="0.002">
    </div>
    <button id="btn-play">ENTRAR A JUGAR</button>
</div>

<div id="ui">Jugadores: <span id="count">1</span></div>

<script type="module">
    import * as THREE from 'https://esm.sh/three@0.160.0';
    import { joinRoom } from 'https://esm.sh/trystero@0.22.0/mqtt';

    let sensibilidad = 0.002;
    let juegoIniciado = false;
    const myColor = Math.floor(Math.random() * 0xffffff);
    let peers = {};

    // --- CONFIGURACIÓN DE RED REDUNDANTE ---
    // Usamos varios servidores. Si uno falla, Trystero prueba el siguiente.
    const config = { 
        appId: 'cubo-arena-v5-final',
        mqttOpts: {
            servers: [
                'wss://broker.emqx.io:8084/mqtt',
                'wss://broker.hivemq.com:8884/mqtt',
                'wss://test.mosquitto.org:8081/mqtt'
            ]
        }
    };
    
    const room = joinRoom(config, 'sala-estratocumulo-2026');
    const [sendMove, getMove] = room.makeAction('m');
    const [sendColor, getColor] = room.makeAction('c');

    // --- ESCENA 3D ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0a0a12);
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    const cameraGroup = new THREE.Group();
    cameraGroup.add(camera);
    scene.add(cameraGroup);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 2));
    scene.add(new THREE.GridHelper(100, 50, 0x00ff88, 0x222222));
    cameraGroup.position.set(Math.random()*4, 1, Math.random()*4);

    // --- LÓGICA DE INTERFAZ ---
    const slider = document.getElementById('sens-slider');
    slider.oninput = () => {
        sensibilidad = parseFloat(slider.value);
        document.getElementById('sens-val').innerText = sensibilidad.toFixed(4);
    };

    document.getElementById('btn-play').onclick = () => {
        renderer.domElement.requestPointerLock();
    };

    document.addEventListener('pointerlockchange', () => {
        juegoIniciado = document.pointerLockElement === renderer.domElement;
        document.getElementById('menu-inicio').style.display = juegoIniciado ? 'none' : 'block';
        document.getElementById('ui').style.display = juegoIniciado ? 'block' : 'none';
    });

    // --- RED ---
    room.onPeerJoin(id => {
        document.getElementById('status-text').innerText = "¡Conectado!";
        document.getElementById('status-text').style.color = "#00ff88";
        sendColor(myColor, id);
    });

    room.onPeerLeave(id => {
        if (peers[id]) { scene.remove(peers[id]); delete peers[id]; updateCount(); }
    });

    getColor((color, id) => {
        if (!peers[id]) {
            const mesh = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1), new THREE.MeshPhongMaterial({ color }));
            mesh.position.y = 0.5;
            scene.add(mesh);
            peers[id] = mesh;
            updateCount();
        }
    });

    getMove((data, id) => {
        if (peers[id]) {
            peers[id].position.set(data.x, 0.5, data.z);
            peers[id].rotation.y = data.ry;
        }
    });

    function updateCount() { document.getElementById('count').innerText = Object.keys(peers).length + 1; }

    // --- MOVIMIENTO ---
    let yaw = 0, pitch = 0;
    document.addEventListener('mousemove', (e) => {
        if (juegoIniciado) {
            yaw -= e.movementX * sensibilidad;
            pitch = Math.max(-1.5, Math.min(1.5, pitch - e.movementY * sensibilidad));
            cameraGroup.rotation.y = yaw;
            camera.rotation.x = pitch;
        }
    });

    const keys = {};
    window.onkeydown = (e) => keys[e.key.toLowerCase()] = true;
    window.onkeyup = (e) => keys[e.key.toLowerCase()] = false;

    function loop() {
        requestAnimationFrame(loop);
        if (juegoIniciado) {
            const speed = 0.15;
            const front = new THREE.Vector3(0, 0, -1).applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw);
            const side = new THREE.Vector3(1, 0, 0).applyAxisAngle(new THREE.Vector3(0, 1, 0), yaw);
            let moved = false;
            if (keys['w']) { cameraGroup.position.addScaledVector(front, speed); moved = true; }
            if (keys['s']) { cameraGroup.position.addScaledVector(front, -speed); moved = true; }
            if (keys['a']) { cameraGroup.position.addScaledVector(side, -speed); moved = true; }
            if (keys['d']) { cameraGroup.position.addScaledVector(side, speed); moved = true; }
            if (moved) sendMove({ x: cameraGroup.position.x, z: cameraGroup.position.z, ry: yaw });
        }
        renderer.render(scene, camera);
    }
    loop();
</script>
</body>
</html>
